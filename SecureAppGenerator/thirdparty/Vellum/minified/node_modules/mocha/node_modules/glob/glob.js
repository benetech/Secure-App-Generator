module.exports=glob;var fs=require("graceful-fs"),minimatch=require("minimatch"),Minimatch=minimatch.Minimatch,inherits=require("inherits"),EE=require("events").EventEmitter,path=require("path"),isDir={},assert=require("assert").ok;function glob(d,b,a){if(typeof b==="function"){a=b,b={}}if(!b){b={}}if(typeof b==="number"){deprecated();return}var c=new Glob(d,b,a);return c.sync?c.found:c}glob.fnmatch=deprecated;function deprecated(){throw new Error("glob's interface has changed. Please see the docs.")}glob.sync=globSync;function globSync(b,a){if(typeof a==="number"){deprecated();return}a=a||{};a.sync=true;return glob(b,a)}glob.Glob=Glob;inherits(Glob,EE);function Glob(e,b,a){if(!(this instanceof Glob)){return new Glob(e,b,a)}if(typeof a==="function"){this.on("error",a);this.on("end",function(h){a(null,h)})}b=b||{};this.EOF={};this._emitQueue=[];this.maxDepth=b.maxDepth||1000;this.maxLength=b.maxLength||Infinity;this.cache=b.cache||{};this.statCache=b.statCache||{};this.changedCwd=false;var d=process.cwd();if(!b.hasOwnProperty("cwd")){this.cwd=d}else{this.cwd=b.cwd;this.changedCwd=path.resolve(b.cwd)!==d}this.root=b.root||path.resolve(this.cwd,"/");this.root=path.resolve(this.root);if(process.platform==="win32"){this.root=this.root.replace(/\\/g,"/")}this.nomount=!!b.nomount;if(!e){throw new Error("must provide pattern")}if(b.matchBase&&-1===e.indexOf("/")){if(b.noglobstar){throw new Error("base matching requires globstar")}e="**/"+e}this.strict=b.strict!==false;this.dot=!!b.dot;this.mark=!!b.mark;this.sync=!!b.sync;this.nounique=!!b.nounique;this.nonull=!!b.nonull;this.nosort=!!b.nosort;this.nocase=!!b.nocase;this.stat=!!b.stat;this.debug=!!b.debug||!!b.globDebug;if(this.debug){this.log=console.error}this.silent=!!b.silent;var f=this.minimatch=new Minimatch(e,b);this.options=f.options;e=this.pattern=f.pattern;this.error=null;this.aborted=false;this._globstars={};EE.call(this);var g=this.minimatch.set.length;this.matches=new Array(g);this.minimatch.set.forEach(c.bind(this));function c(j,h,k){this._process(j,0,h,function(i){if(i){this.emit("error",i)}if(--g<=0){this._finish()}})}}Glob.prototype.log=function(){};Glob.prototype._finish=function(){assert(this instanceof Glob);var f=this.nounique,e=f?[]:{};for(var c=0,b=this.matches.length;c<b;c++){var g=this.matches[c];this.log("matches[%d] =",c,g);if(!g){if(this.nonull){var d=this.minimatch.globSet[c];if(f){e.push(d)}else{e[d]=true}}}else{var a=Object.keys(g);if(f){e.push.apply(e,a)}else{a.forEach(function(h){e[h]=true})}}}if(!f){e=Object.keys(e)}if(!this.nosort){e=e.sort(this.nocase?alphasorti:alphasort)}if(this.mark){e=e.map(function(h){var j=this.cache[h];if(!j){return h}var i=(Array.isArray(j)||j===2);if(i&&h.slice(-1)!=="/"){return h+"/"}if(!i&&h.slice(-1)==="/"){return h.replace(/\/+$/,"")}return h},this)}this.log("emitting end",e);this.EOF=this.found=e;this.emitMatch(this.EOF)};function alphasorti(d,c){d=d.toLowerCase();c=c.toLowerCase();return alphasort(d,c)}function alphasort(d,c){return d>c?1:d<c?-1:0}Glob.prototype.abort=function(){this.aborted=true;this.emit("abort")};Glob.prototype.pause=function(){if(this.paused){return}if(this.sync){this.emit("error",new Error("Can't pause/resume sync glob"))}this.paused=true;this.emit("pause")};Glob.prototype.resume=function(){if(!this.paused){return}if(this.sync){this.emit("error",new Error("Can't pause/resume sync glob"))}this.paused=false;this.emit("resume");this._processEmitQueue()};Glob.prototype.emitMatch=function(a){if(!this.stat||this.statCache[a]||a===this.EOF){this._emitQueue.push(a);this._processEmitQueue()}else{this._stat(a,function(b,c){if(b){this._emitQueue.push(a);this._processEmitQueue()}})}};Glob.prototype._processEmitQueue=function(a){while(!this._processingEmitQueue&&!this.paused){this._processingEmitQueue=true;var a=this._emitQueue.shift();if(!a){this._processingEmitQueue=false;break}this.log("emit!",a===this.EOF?"end":"match");this.emit(a===this.EOF?"end":"match",a);this._processingEmitQueue=false}};Glob.prototype._process=function(f,g,c,b){assert(this instanceof Glob);var a=function a(j,i){assert(this instanceof Glob);if(this.paused){if(!this._processQueue){this._processQueue=[];this.once("resume",function(){var k=this._processQueue;this._processQueue=null;k.forEach(function(l){l()})})}this._processQueue.push(b.bind(this,j,i))}else{b.call(this,j,i)}}.bind(this);if(this.aborted){return a()}if(g>this.maxDepth){return a()}var h=0;while(typeof f[h]==="string"){h++}var e;switch(h){case f.length:e=f.join("/");this._stat(e,function(i,j){if(i){if(e&&isAbsolute(e)&&!this.nomount){if(e.charAt(0)==="/"){e=path.join(this.root,e)}else{e=path.resolve(this.root,e)}}if(process.platform==="win32"){e=e.replace(/\\/g,"/")}this.matches[c]=this.matches[c]||{};this.matches[c][e]=true;this.emitMatch(e)}return a()});return;case 0:e=null;break;default:e=f.slice(0,h);e=e.join("/");break}var d;if(e===null){d="."}else{if(isAbsolute(e)||isAbsolute(f.join("/"))){if(!e||!isAbsolute(e)){e=path.join("/",e)}d=e=path.resolve(e);this.log("absolute: ",e,this.root,f,d)}else{d=e}}this.log("readdir(%j)",d,this.cwd,this.root);return this._readdir(d,function(q,i){if(q){return a()}if(f[h]===minimatch.GLOBSTAR){var n=[f.slice(0,h).concat(f.slice(h+1))];i.forEach(function(l){if(l.charAt(0)==="."&&!this.dot){return}n.push(f.slice(0,h).concat(l).concat(f.slice(h+1)));n.push(f.slice(0,h).concat(l).concat(f.slice(h)))},this);n=n.filter(function(s){var r=gsKey(s);var l=!this._globstars[r];this._globstars[r]=true;return l},this);if(!n.length){return a()}var k=n.length,p=null;n.forEach(function(l){this._process(l,g+1,c,function(r){if(p){return}if(r){return a(p=r)}if(--k<=0){return a()}})},this);return}var m=f[h];var j=f[h]._glob,o=this.dot||j.charAt(0)===".";i=i.filter(function(l){return(l.charAt(0)!=="."||o)&&l.match(f[h])});if(h===f.length-1&&!this.mark&&!this.stat){i.forEach(function(l){if(e){if(e!=="/"){l=e+"/"+l}else{l=e+l}}if(l.charAt(0)==="/"&&!this.nomount){l=path.join(this.root,l)}if(process.platform==="win32"){l=l.replace(/\\/g,"/")}this.matches[c]=this.matches[c]||{};this.matches[c][l]=true;this.emitMatch(l)},this);return a.call(this)}var k=i.length,p=null;if(k===0){return a()}i.forEach(function(r){var l=f.slice(0,h).concat(r).concat(f.slice(h+1));this._process(l,g+1,c,function(s){if(p){return}if(s){return a(p=s)}if(--k===0){return a.call(this)}})},this)})};function gsKey(a){return"**"+a.map(function(b){return(b===minimatch.GLOBSTAR)?"**":(""+b)}).join("/")}Glob.prototype._stat=function(g,b){assert(this instanceof Glob);var a=g;if(g.charAt(0)==="/"){a=path.join(this.root,g)}else{if(this.changedCwd){a=path.resolve(this.cwd,g)}}if(g.length>this.maxLength){var j=new Error("Path name too long");j.code="ENAMETOOLONG";j.path=g;return this._afterStat(g,a,b,j)}this.log("stat",[this.cwd,g,"=",a]);if(!this.stat&&this.cache.hasOwnProperty(g)){var d=this.cache[g],i=d&&(Array.isArray(d)||d===2);if(this.sync){return b.call(this,!!d,i)}return process.nextTick(b.bind(this,!!d,i))}var c=this.statCache[a];if(this.sync||c){var j;try{c=fs.statSync(a)}catch(h){j=h}this._afterStat(g,a,b,j,c)}else{fs.stat(a,this._afterStat.bind(this,g,a,b))}};Glob.prototype._afterStat=function(g,b,a,h,d){var e;assert(this instanceof Glob);if(b.slice(-1)==="/"&&d&&!d.isDirectory()){this.log("should be ENOTDIR, fake it");h=new Error("ENOTDIR, not a directory '"+b+"'");h.path=b;h.code="ENOTDIR";d=null}var c=!this.statCache[b];this.statCache[b]=d;if(h||!d){e=false}else{e=d.isDirectory()?2:1;if(c){this.emit("stat",g,d)}}this.cache[g]=this.cache[g]||e;a.call(this,!!e,e===2)};Glob.prototype._readdir=function(h,d){assert(this instanceof Glob);var b=h;if(h.charAt(0)==="/"){b=path.join(this.root,h)}else{if(isAbsolute(h)){b=h}else{if(this.changedCwd){b=path.resolve(this.cwd,h)}}}if(h.length>this.maxLength){var k=new Error("Path name too long");k.code="ENAMETOOLONG";k.path=h;return this._afterReaddir(h,b,d,k)}this.log("readdir",[this.cwd,h,b]);if(this.cache.hasOwnProperty(h)){var j=this.cache[h];if(Array.isArray(j)){if(this.sync){return d.call(this,null,j)}return process.nextTick(d.bind(this,null,j))}if(!j||j===1){var g=j?"ENOTDIR":"ENOENT",k=new Error((j?"Not a directory":"Not found")+": "+h);k.path=h;k.code=g;this.log(h,k);if(this.sync){return d.call(this,k)}return process.nextTick(d.bind(this,k))}}if(this.sync){var k,a;try{a=fs.readdirSync(b)}catch(i){k=i}return this._afterReaddir(h,b,d,k,a)}fs.readdir(b,this._afterReaddir.bind(this,h,b,d))};Glob.prototype._afterReaddir=function(d,c,b,e,a){assert(this instanceof Glob);if(a&&!e){this.cache[d]=a;if(!this.mark&&!this.stat){a.forEach(function(f){if(d==="/"){f=d+f}else{f=d+"/"+f}this.cache[f]=true},this)}return b.call(this,e,a)}if(e){switch(e.code){case"ENOTDIR":this.cache[d]=1;return b.call(this,e);case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[d]=false;return b.call(this,e);default:this.cache[d]=false;if(this.strict){this.emit("error",e)}if(!this.silent){console.error("glob error",e)}return b.call(this,e)}}};var isAbsolute=process.platform==="win32"?absWin:absUnix;function absWin(e){if(absUnix(e)){return true}var d=/^([a-zA-Z]:|[\\\/]{2}[^\\\/]+[\\\/]+[^\\\/]+)?([\\\/])?([\s\S]*?)$/,a=d.exec(e),b=a[1]||"",f=b&&b.charAt(1)!==":",c=!!a[2]||f;return c}function absUnix(a){return a.charAt(0)==="/"||a===""};