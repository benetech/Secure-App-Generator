module.exports=glob;var fs=require("graceful-fs"),minimatch=require("minimatch"),Minimatch=minimatch.Minimatch,inherits=require("inherits"),EE=require("events").EventEmitter,path=require("path"),isDir={},assert=require("assert").ok,once=require("once");function glob(d,b,a){if(typeof b==="function"){a=b,b={}}if(!b){b={}}if(typeof b==="number"){deprecated();return}var c=new Glob(d,b,a);return c.sync?c.found:c}glob.fnmatch=deprecated;function deprecated(){throw new Error("glob's interface has changed. Please see the docs.")}glob.sync=globSync;function globSync(b,a){if(typeof a==="number"){deprecated();return}a=a||{};a.sync=true;return glob(b,a)}this._processingEmitQueue=false;glob.Glob=Glob;inherits(Glob,EE);function Glob(e,b,a){if(!(this instanceof Glob)){return new Glob(e,b,a)}if(typeof b==="function"){a=b;b=null}if(typeof a==="function"){a=once(a);this.on("error",a);this.on("end",function(h){a(null,h)})}b=b||{};this._endEmitted=false;this.EOF={};this._emitQueue=[];this.paused=false;this._processingEmitQueue=false;this.maxDepth=b.maxDepth||1000;this.maxLength=b.maxLength||Infinity;this.cache=b.cache||{};this.statCache=b.statCache||{};this.changedCwd=false;var d=process.cwd();if(!b.hasOwnProperty("cwd")){this.cwd=d}else{this.cwd=b.cwd;this.changedCwd=path.resolve(b.cwd)!==d}this.root=b.root||path.resolve(this.cwd,"/");this.root=path.resolve(this.root);if(process.platform==="win32"){this.root=this.root.replace(/\\/g,"/")}this.nomount=!!b.nomount;if(!e){throw new Error("must provide pattern")}if(b.matchBase&&-1===e.indexOf("/")){if(b.noglobstar){throw new Error("base matching requires globstar")}e="**/"+e}this.strict=b.strict!==false;this.dot=!!b.dot;this.mark=!!b.mark;this.sync=!!b.sync;this.nounique=!!b.nounique;this.nonull=!!b.nonull;this.nosort=!!b.nosort;this.nocase=!!b.nocase;this.stat=!!b.stat;this.debug=!!b.debug||!!b.globDebug;if(/\bglob\b/.test(process.env.NODE_DEBUG||"")){this.debug=true}if(this.debug){this.log=console.error}this.silent=!!b.silent;var f=this.minimatch=new Minimatch(e,b);this.options=f.options;e=this.pattern=f.pattern;this.error=null;this.aborted=false;this._globstars={};EE.call(this);var g=this.minimatch.set.length;this.matches=new Array(g);if(this.minimatch.set.length===0){return process.nextTick(this._finish.bind(this))}this.minimatch.set.forEach(c.bind(this));function c(j,h,k){this._process(j,0,h,function(i){if(i){this.emit("error",i)}if(--g<=0){this._finish()}})}}Glob.prototype.log=function(){};Glob.prototype._finish=function(){assert(this instanceof Glob);var f=this.nounique,e=f?[]:{};for(var c=0,b=this.matches.length;c<b;c++){var g=this.matches[c];this.log("matches[%d] =",c,g);if(!g){if(this.nonull){var d=this.minimatch.globSet[c];if(f){e.push(d)}else{e[d]=true}}}else{var a=Object.keys(g);if(f){e.push.apply(e,a)}else{a.forEach(function(h){e[h]=true})}}}if(!f){e=Object.keys(e)}if(!this.nosort){e=e.sort(this.nocase?alphasorti:alphasort)}if(this.mark){e=e.map(this._mark,this)}this.log("emitting end",e);this.EOF=this.found=e;this.emitMatch(this.EOF)};function alphasorti(d,c){d=d.toLowerCase();c=c.toLowerCase();return alphasort(d,c)}function alphasort(d,c){return d>c?1:d<c?-1:0}Glob.prototype._mark=function(d){var f=this.cache[d];var a=d;if(f){var e=f===2||Array.isArray(f);var b=d.slice(-1)==="/";if(e&&!b){a+="/"}else{if(!e&&b){a=a.slice(0,-1)}}if(a!==d){this.statCache[a]=this.statCache[d];this.cache[a]=this.cache[d]}}return a};Glob.prototype.abort=function(){this.aborted=true;this.emit("abort")};Glob.prototype.pause=function(){if(this.paused){return}if(this.sync){this.emit("error",new Error("Can't pause/resume sync glob"))}this.paused=true;this.emit("pause")};Glob.prototype.resume=function(){if(!this.paused){return}if(this.sync){this.emit("error",new Error("Can't pause/resume sync glob"))}this.paused=false;this.emit("resume");this._processEmitQueue()};Glob.prototype.emitMatch=function(a){this.log("emitMatch",a);this._emitQueue.push(a);this._processEmitQueue()};Glob.prototype._processEmitQueue=function(a){this.log("pEQ paused=%j processing=%j m=%j",this.paused,this._processingEmitQueue,a);var b=false;while(!this._processingEmitQueue&&!this.paused){this._processingEmitQueue=true;var a=this._emitQueue.shift();this.log(">processEmitQueue",a===this.EOF?":EOF:":a);if(!a){this.log(">processEmitQueue, falsey m");this._processingEmitQueue=false;break}if(a===this.EOF||!(this.mark&&!this.stat)){this.log("peq: unmarked, or eof");c.call(this,0,false)}else{if(this.statCache[a]){var e=this.statCache[a];var d;if(e){d=e.isDirectory()?2:1}this.log("peq: stat cached");c.call(this,d,d===2)}else{this.log("peq: _stat, then next");this._stat(a,c)}}}b=true;function c(g,h){this.log("next",a,g,h);var f=a===this.EOF?"end":"match";assert(!this._endEmitted);if(f==="end"){this._endEmitted=true}if(g){if(h&&!a.match(/\/$/)){a=a+"/"}else{if(!h&&a.match(/\/$/)){a=a.replace(/\/+$/,"")}}}this.log("emit",f,a);this.emit(f,a);this._processingEmitQueue=false;if(b&&a!==this.EOF&&!this.paused){this._processEmitQueue()}}};Glob.prototype._process=function(f,g,c,b){assert(this instanceof Glob);var a=function a(j,i){assert(this instanceof Glob);if(this.paused){if(!this._processQueue){this._processQueue=[];this.once("resume",function(){var k=this._processQueue;this._processQueue=null;k.forEach(function(l){l()})})}this._processQueue.push(b.bind(this,j,i))}else{b.call(this,j,i)}}.bind(this);if(this.aborted){return a()}if(g>this.maxDepth){return a()}var h=0;while(typeof f[h]==="string"){h++}var e;switch(h){case f.length:e=f.join("/");this._stat(e,function(i,j){if(i){if(e&&isAbsolute(e)&&!this.nomount){if(e.charAt(0)==="/"){e=path.join(this.root,e)}else{e=path.resolve(this.root,e)}}if(process.platform==="win32"){e=e.replace(/\\/g,"/")}this.matches[c]=this.matches[c]||{};this.matches[c][e]=true;this.emitMatch(e)}return a()});return;case 0:e=null;break;default:e=f.slice(0,h);e=e.join("/");break}var d;if(e===null){d="."}else{if(isAbsolute(e)||isAbsolute(f.join("/"))){if(!e||!isAbsolute(e)){e="/"+e}d=e;this.log("absolute: ",e,this.root,f,d)}else{d=e}}this.log("readdir(%j)",d,this.cwd,this.root);return this._readdir(d,function(q,o){if(q){return a()}if(f[h]===minimatch.GLOBSTAR){var r=[f.slice(0,h).concat(f.slice(h+1))];o.forEach(function(l){if(l.charAt(0)==="."&&!this.dot){return}r.push(f.slice(0,h).concat(l).concat(f.slice(h+1)));r.push(f.slice(0,h).concat(l).concat(f.slice(h)))},this);r=r.filter(function(t){var s=gsKey(t);var l=!this._globstars[s];this._globstars[s]=true;return l},this);if(!r.length){return a()}var j=r.length,p=null;r.forEach(function(l){this._process(l,g+1,c,function(s){if(p){return}if(s){return a(p=s)}if(--j<=0){return a()}})},this);return}var i=f[h];var n=!!this.minimatch.negate;var k=f[h]._glob,m=this.dot||k.charAt(0)===".";o=o.filter(function(l){if(l.charAt(0)!=="."||m){if(n&&h===0){return !l.match(f[h])}else{return l.match(f[h])}}return null});if(h===f.length-1&&!this.mark&&!this.stat){o.forEach(function(l){if(e){if(e!=="/"){l=e+"/"+l}else{l=e+l}}if(l.charAt(0)==="/"&&!this.nomount){l=path.join(this.root,l)}if(process.platform==="win32"){l=l.replace(/\\/g,"/")}this.matches[c]=this.matches[c]||{};this.matches[c][l]=true;this.emitMatch(l)},this);return a.call(this)}var j=o.length,p=null;if(j===0){return a()}o.forEach(function(s){var l=f.slice(0,h).concat(s).concat(f.slice(h+1));this._process(l,g+1,c,function(t){if(p){return}if(t){return a(p=t)}if(--j===0){return a.call(this)}})},this)})};function gsKey(a){return"**"+a.map(function(b){return(b===minimatch.GLOBSTAR)?"**":(""+b)}).join("/")}Glob.prototype._stat=function(g,b){assert(this instanceof Glob);var a=g;if(g.charAt(0)==="/"){a=path.join(this.root,g)}else{if(this.changedCwd){a=path.resolve(this.cwd,g)}}if(g.length>this.maxLength){var j=new Error("Path name too long");j.code="ENAMETOOLONG";j.path=g;return this._afterStat(g,a,b,j)}this.log("stat",[this.cwd,g,"=",a]);if(!this.stat&&this.cache.hasOwnProperty(g)){var d=this.cache[g],i=d&&(Array.isArray(d)||d===2);if(this.sync){return b.call(this,!!d,i)}return process.nextTick(b.bind(this,!!d,i))}var c=this.statCache[a];if(this.sync||c){var j;try{c=fs.statSync(a)}catch(h){j=h}this._afterStat(g,a,b,j,c)}else{fs.stat(a,this._afterStat.bind(this,g,a,b))}};Glob.prototype._afterStat=function(g,b,a,h,d){var e;assert(this instanceof Glob);if(b.slice(-1)==="/"&&d&&!d.isDirectory()){this.log("should be ENOTDIR, fake it");h=new Error("ENOTDIR, not a directory '"+b+"'");h.path=b;h.code="ENOTDIR";d=null}var c=!this.statCache[b];this.statCache[b]=d;if(h||!d){e=false}else{e=d.isDirectory()?2:1;if(c){this.emit("stat",g,d)}}this.cache[g]=this.cache[g]||e;a.call(this,!!e,e===2)};Glob.prototype._readdir=function(h,d){assert(this instanceof Glob);var b=h;if(h.charAt(0)==="/"){b=path.join(this.root,h)}else{if(isAbsolute(h)){b=h}else{if(this.changedCwd){b=path.resolve(this.cwd,h)}}}if(h.length>this.maxLength){var k=new Error("Path name too long");k.code="ENAMETOOLONG";k.path=h;return this._afterReaddir(h,b,d,k)}this.log("readdir",[this.cwd,h,b]);if(this.cache.hasOwnProperty(h)){var j=this.cache[h];if(Array.isArray(j)){if(this.sync){return d.call(this,null,j)}return process.nextTick(d.bind(this,null,j))}if(!j||j===1){var g=j?"ENOTDIR":"ENOENT",k=new Error((j?"Not a directory":"Not found")+": "+h);k.path=h;k.code=g;this.log(h,k);if(this.sync){return d.call(this,k)}return process.nextTick(d.bind(this,k))}}if(this.sync){var k,a;try{a=fs.readdirSync(b)}catch(i){k=i}return this._afterReaddir(h,b,d,k,a)}fs.readdir(b,this._afterReaddir.bind(this,h,b,d))};Glob.prototype._afterReaddir=function(d,c,b,e,a){assert(this instanceof Glob);if(a&&!e){this.cache[d]=a;if(!this.mark&&!this.stat){a.forEach(function(f){if(d==="/"){f=d+f}else{f=d+"/"+f}this.cache[f]=true},this)}return b.call(this,e,a)}if(e){switch(e.code){case"ENOTDIR":this.cache[d]=1;return b.call(this,e);case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[d]=false;return b.call(this,e);default:this.cache[d]=false;if(this.strict){this.emit("error",e)}if(!this.silent){console.error("glob error",e)}return b.call(this,e)}}};var isAbsolute=process.platform==="win32"?absWin:absUnix;function absWin(e){if(absUnix(e)){return true}var d=/^([a-zA-Z]:|[\\\/]{2}[^\\\/]+[\\\/]+[^\\\/]+)?([\\\/])?([\s\S]*?)$/,a=d.exec(e),b=a[1]||"",f=b&&b.charAt(1)!==":",c=!!a[2]||f;return c}function absUnix(a){return a.charAt(0)==="/"||a===""};